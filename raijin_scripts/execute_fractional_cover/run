#!/bin/bash

set -eu


while [[ $# -gt 0 ]]; do
    key="$1"
    case ${key} in
        --year )                shift
                                YEAR=$1
                                ;;
        --output-product )      shift
                                OUTPUT_PRODUCT=$1
                                ;;
        --tag )                 shift
                                TAG=$1
                                ;;
        --fc-module )           shift
                                FC_MODULE=$1
                                ;;
        --dea-module )          shift
                                DEA_MODULE=$1
                                ;;
        --queue )               shift
                                QUEUE=$1
                                ;;
        --project )             shift
                                PROJECT=$1
                                ;;
        * )                     exit 1
    esac
    shift
done


echo Executing fractional cover for "${YEAR}" "${OUTPUT_PRODUCT}" with tag "${TAG}"
echo Loading modules "${DEA_MODULE}" and "${FC_MODULE}"

module use /g/data/v10/public/modules/modulefiles
module use /g/data/v10/private/modules/modulefiles

module load "${DEA_MODULE}"
module load "${FC_MODULE}"

cd /g/data/v10/work/fc/

APP_CONFIG=$(datacube-fc list | grep "${OUTPUT_PRODUCT}")


datacube-fc submit -v -v --project "${PROJECT}" --queue "${QUEUE}" --year "${YEAR}" --app-config "${APP_CONFIG}" --tag "${TAG}"
