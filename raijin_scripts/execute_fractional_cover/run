#!/bin/bash

set -eu


while [[ $# -gt 0 ]]; do
    key="$1"
    case ${key} in
        --year )                shift
                                YEAR=$1
                                ;;
        --output-product )      shift
                                OUTPUT_PRODUCT=$1
                                ;;
        --tag )                 shift
                                TAG=$1
                                ;;
        --agdc-module )         shift
                                AGDC_MODULE=$1
                                ;;
        --fc-module )           shift
                                FC_MODULE=$1
                                ;;
        --dea-module )          shift
                                DEA_MODULE=$1
                                ;;
        * )                     exit 1
    esac
    shift
done


echo Executing fractional cover for "${YEAR}" "${OUTPUT_PRODUCT}" with tag "${TAG}"
echo Loading modules "${AGDC_MODULE}", "${FC_MODULE}" and "${DEA_MODULE}"

module use /g/data/v10/public/modules/modulefiles
module use /g/data/v10/private/modules/modulefiles

module load "${AGDC_MODULE}"
module load "${FC_MODULE}"
module load "${DEA_MODULE}"


APP_CONFIG=/g/data/v10/public/modules/${FC_MODULE}/config/${OUTPUT_PRODUCT}.yaml



datacube-fc submit --project "${PROJECT}" --queue "${QUEUE}" --year "${YEAR}" --app-config "${APP_CONFIG}" --tag "${TAG}"

# TODO: what's happening with the logging??
