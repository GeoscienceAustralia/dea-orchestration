#!/bin/bash
set -eu

while [[ "$#" -gt 0 ]]; do
    key="$1"
    case "${key}" in
        --dea-module )          shift
                                MODULE="$1"
                                ;;
        --queue )               shift
                                QUEUE="$1"
                                ;;
        --project )             shift
                                PROJECT="$1"
                                ;;
        --cog-product )         shift
                                PRODUCT="$1"
                                ;;
        --time-range )          shift
                                RANGE_EXP="$*"
                                break # Last input argument and hence exiting while loop
                                ;;
        * )
          echo "Input key, '$key', did not match the expected input argument key"
          exit 1
          ;;
    esac
    shift
done

WORKDIR=/g/data/v10/work/cog_conversion/"$PRODUCT"/$(date '+%F_%T')
SUBMISSION_LOG="$WORKDIR"/Cog_Submission_$(date '+%s').log
START_YEAR=$(echo "$RANGE_EXP" | cut -f 1 -d '-')
END_YEAR=$(echo "$RANGE_EXP" | cut -f 2 -d '-')
TIME_RANGE_TO_PROCESS=()

mkdir -p "${WORKDIR}"

module use /g/data/v10/public/modules/modulefiles
module load "${MODULE}"

for (( year = "$START_YEAR"; year <= "$END_YEAR"; ++year )); do
    for (( month = 01; month <= 12; ++month )); do
        TIME_RANGE_TO_PROCESS+=("'time in $year-$month'")
    done
done

echo "Start time: $(date '+%F-%T')

Loading module ${MODULE}

# Check if we can connect to the database
$(datacube -vv system check)
" > "$SUBMISSION_LOG"

cd "${WORKDIR}"

echo ""
echo "Starting Cog-Conversion process......"

j=0
for timeperiod in "${TIME_RANGE_TO_PROCESS[@]}"
do
  j=$((j+1))
  nohup "$SHELL" >> "$SUBMISSION_LOG" 2>&1 << EOF &
  ##################################################################################################
  # Qsub cog-convert process
  ##################################################################################################
  mkdir -p "${WORKDIR}/cache_$j"
  echo ""
  echo "Executing: python3 $HOME/COG-Conversion/converter/cog_conv_app.py qsub-cog-convert -q ${QUEUE} -P ${PROJECT}
  -p ${PRODUCT} --walltime 20 --output-dir ${WORKDIR}/cache_$j --time-range ${timeperiod}"

  python3 "$HOME"/COG-Conversion/converter/cog_conv_app.py qsub-cog-convert -q ${QUEUE} -P ${PROJECT} -p ${PRODUCT} \
  --walltime 20 --output-dir ${WORKDIR}/cache_$j --time-range ${timeperiod}
EOF
done
