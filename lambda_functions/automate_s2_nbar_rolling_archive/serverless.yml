service: automate-s2-rolling-archive

plugins:
  - serverless-python-requirements
  - serverless-pseudo-parameters
custom:
  pythonRequirements:
    dockerizePip: non-linux
  Stage: ${opt:stage, self:provider.stage}
  profiles:
    dev: devProfile
    prod: prodProfile
  s3Bucket:
    prod: "dea-public-data"
    dev: "dea-public-data-dev"

package:
  exclude:
    - node_modules/**
    - .idea/**
    - .requirements/**
    - env/**
    - README.md
    - package.json
    - package-lock.json
    - requirements.txt

provider:
  name: aws
  runtime: python3.7
  timeout: 300  # 5 mins. Default is 6 seconds
  memorySize: 128  # in MB, default is 1024
  region: ap-southeast-2
  stage: dev
  profile: ${self:custom.profiles.${self:custom.Stage}}
  tags:
    repo: https://github.com/GeoscienceAustralia/dea-orchestration
    author: nci.monitor@dea.ga.gov.au
    purpose: s2-nbar-rolling-archive-automation
  iamRoleStatements:
  - Effect: 'Allow'
    Action:
      - 'ssm:GetParameters'
      - 'ssm:GetParameter'
      - 'ssm:DescribeParameters'
    Resource:
      - "arn:aws:ssm:#{AWS::Region}:#{AWS::AccountId}:parameter/orchestrator.*"
      - "arn:aws:ssm:#{AWS::Region}:#{AWS::AccountId}:parameter/pipeline.*"
  - Effect: 'Allow'
    Action: 'kms:Decrypt'
    Resource:
      - "arn:aws:kms:#{AWS::Region}:#{AWS::AccountId}:key/*"
  - Effect: "Allow"
    Resource: "*"
    Action:
      - "sns:*"
  - Effect: "Allow"
    Action:
      - "s3:*"
    Resource: "*"

  # Service wide environment variables declaration
  environment:
    SSM_USER_PATH: 'orchestrator.raijin.users.default'
    LEVEL1_DONE_LIST: "/g/data/v10/work/s2_ard/wagl/batchid-ab64e286ad/level-1-failed.txt,"
    AWS_PROFILE_NAME: ${self:custom.profiles.${self:custom.Stage}}
    S3_BUCKET: ${self:custom.s3Bucket.${self:custom.Stage}}

functions:
  execute_s2nbar_rolling_archive:
    handler: execute_s2nbar.handler.handler
    description: Automate rolling archive for Sentinel 2 NBAR
    events:
      - schedule: cron(55 12 ? * THU *)  # Run every Thursday, at 10:30 am Canberra time
