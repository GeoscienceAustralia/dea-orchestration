dist: trusty
# tests primarily focused on lambda component
language: python
python:
  - "3.6"
sudo: false
addons:
  apt:
    packages:
      - shellcheck

env:
  global:
    - DEA_ENVIRONMENT='test'

git:
  depth: 99999


cache:
  directories:
    - $HOME/.cache/pip

install:
  - pip install -r requirements.txt
  - ./scripts/install_script all

script:
  - npm install -g serverless
  - ./scripts/check-code.sh

before_deploy:
  - cd lambda_functions/execute_ssh_command_js/ && npm install
  - npm --version
  - pip install awscli --upgrade --user
  - aws --version
  - aws configure set aws_access_key_id aws_access_key_id --profile prodProfile
  - aws configure set aws_secret_access_key aws_secret_access_key --profile prodProfile
  - aws configure set region AWS_DEFAULT_REGION --profile prodProfile

deploy:
 -  provider: script
    script:
      # Serverless deploy to production environment after merging to production branch
      # AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are expected to be configured in travis web settings
      - sls deploy -v -s prod
    skip_cleanup: true # Don't re-run the tests
    on:
        all_branches: true